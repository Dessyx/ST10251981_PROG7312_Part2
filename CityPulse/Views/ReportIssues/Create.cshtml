@{
    ViewData["Title"] = "Report Issues";
}

<div class="app-container">
    <div class="header">
        <div class="sa-flag"></div>
        <h1>City Connect</h1>
        <p>Report an Issue</p>
    </div>
    <div class="content">
        <form asp-action="Create" asp-controller="ReportIssues" method="post" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="location" class="form-label">Location</label>
                <input id="location" name="location" class="form-input" placeholder="Start typing..." autocomplete="off" />
                <div id="location-help" class="form-text">Type to see suggestions</div>
                <div id="suggestions" class="list-group"></div>
            </div>

            <div class="mb-3">
                <label for="category" class="form-label">Category</label>
                <select id="category" name="category" class="form-select">
                    <option value="Sanitation">Sanitation</option>
                    <option value="Roads">Roads</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Water">Water</option>
                    <option value="Electricity">Electricity</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea id="description" name="description" class="form-textarea" rows="6"></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Attach images/documents (max 5MB each)</label>
                <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ðŸ“Ž</div>
                    <p><strong>Click to upload files</strong></p>
                    <p style="color:#718096; font-size:.9em;">Images, PDFs, or documents</p>
                </div>
                <input id="fileInput" type="file" name="files" multiple class="d-none" />
            </div>

            <div class="mb-3">
                <div class="progress progress-slim">
                    <div id="progressBar" class="fill" style="width:0%"></div>
                </div>
                <div id="engagement" class="form-text mt-1">Let's keep our city clean together!</div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Submit</button>
                <a class="btn btn-secondary" asp-controller="Home" asp-action="Index">Back to Main Menu</a>
            </div>
        </form>
    </div>
</div>

<script>
    (function() {
        const locationInput = document.getElementById('location');
        const suggestions = document.getElementById('suggestions');
        const progressBar = document.getElementById('progressBar');
        const engagement = document.getElementById('engagement');

        function updateProgress() {
            let progress = 0;
            if (locationInput.value.trim().length > 0) progress += 25;
            if (document.getElementById('category').value) progress += 25;
            if (document.getElementById('description').value.trim().length > 0) progress += 25;
            const files = document.querySelector('input[type="file"]').files;
            if (files && files.length > 0) progress += 25;
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
            engagement.textContent = progress === 100 ? 'Great job! Ready to submit.' : 'You are ' + progress + '% there!';
        }

        locationInput.addEventListener('input', async function() {
            updateProgress();
            const q = locationInput.value;
            suggestions.innerHTML = '';
            if (q.length < 2) return;
            const res = await fetch('/ReportIssues/LocationSuggest?q=' + encodeURIComponent(q));
            const data = await res.json();
            // data.suggestions is an enumerable queue; iterate as array-like
            for (const s of data.suggestions) {
                const a = document.createElement('a');
                a.href = '#';
                a.className = 'list-group-item list-group-item-action';
                a.textContent = s;
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    locationInput.value = s;
                    suggestions.innerHTML = '';
                    updateProgress();
                });
                suggestions.appendChild(a);
            }
        });

        document.getElementById('category').addEventListener('change', updateProgress);
        document.getElementById('description').addEventListener('input', updateProgress);
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', function() {
            const files = this.files;
            for (const f of files) {
                if (f.size > 5 * 1024 * 1024) {
                    alert('File exceeds 5MB: ' + f.name);
                    fileInput.value = '';
                    break;
                }
            }
            updateProgress();
        });
    })();
</script>


